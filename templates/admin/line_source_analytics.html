{% extends "admin/base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/line-source-analytics.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
  <!-- ヘッダー -->
  <div class="admin-header">
    <h1>LINE流入経路分析</h1>
    <div class="admin-description">友だち登録の流入経路を分析し、効果的なマーケティング戦略を立てることができます。</div>
  </div>
  
  <!-- メインコンテンツ -->
  <div class="admin-main">
    <!-- 左サイドバー（フォルダ一覧） -->
    <div class="admin-sidebar">
      <div class="sidebar-header">
        <button class="new-folder-btn" data-bs-toggle="modal" data-bs-target="#createFolderModal">
          <i class="fas fa-plus"></i> 新しいフォルダ
        </button>
      </div>
      
      <ul class="sidebar-list">
        <!-- フォルダ一覧 -->
        {% for folder in folders %}
        <li class="sidebar-item {% if selected_folder_id == folder.id %}active{% endif %}">
          <a href="{{ url_for('line_source_analytics', folder_id=folder.id) }}" class="sidebar-link">
            <i class="fas fa-folder"></i>
            <span>{{ folder.name }}</span>
          </a>
          {% if folder.name != '未分類' %}
          <div class="folder-actions">
            <button class="action-btn edit-folder-btn" data-folder-id="{{ folder.id }}" data-folder-name="{{ folder.name }}" title="編集">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-folder-btn" data-folder-id="{{ folder.id }}" data-folder-name="{{ folder.name }}" title="削除">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </div>
    
    <!-- メインコンテンツエリア -->
    <div class="admin-content">
      <!-- ツールバー -->
      <div class="admin-toolbar">
        <div class="toolbar-left">
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newLinkModal">
            <i class="fas fa-plus"></i> 新しい登録リンクを作成
          </button>
        </div>
        <div class="toolbar-right">
          {% for folder in folders %}
            {% if folder.id == selected_folder_id %}
              <span class="text-muted">フォルダ: {{ folder.name }}</span>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      
      <!-- フラッシュメッセージ表示 -->
      {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
              {% for category, message in messages %}
                  <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show">
                      {{ message }}
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  </div>
              {% endfor %}
          {% endif %}
      {% endwith %}
      
      <!-- 登録リンク一覧 -->
      <div class="admin-table">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 30%;">リンク名</th>
              <th style="width: 15%;">フォルダ</th>
              <th style="width: 15%;">登録者数</th>
              <th style="width: 20%;">作成日</th>
              <th style="width: 20%;">操作</th>
            </tr>
          </thead>
          <tbody>
            {% for link in registration_links %}
            <tr>
              <td>
                <div class="data-item">
                  <div class="item-title">{{ link.name }}</div>
                </div>
              </td>
              <td>
                {% if link.folder_name %}
                  <span class="folder-badge">{{ link.folder_name }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                <a href="{{ url_for('line_source_analytics_users', link_id=link.id) }}" class="text-decoration-none">
                  <span class="status-badge active">{{ link.registration_count }}人</span>
                </a>
              </td>
              <td class="item-date">{{ link.created_at }}</td>
              <td>
                <div class="item-actions">
                  <button class="action-btn copy-link" data-link="{{ link.full_url }}" title="リンクをコピー">
                    <i class="fas fa-copy"></i>
                  </button>
                  <button class="action-btn delete-btn" data-bs-toggle="modal" data-bs-target="#deleteLinkModal{{ link.id }}" title="削除">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                
                <!-- 削除確認モーダル -->
                <div class="modal fade" id="deleteLinkModal{{ link.id }}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">リンク削除の確認</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <p>リンク「{{ link.name }}」を削除してもよろしいですか？</p>
                        <p class="text-danger">この操作は取り消せません。このリンクから登録したユーザーの流入元情報も削除されます。</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <form method="POST" action="{{ url_for('delete_registration_link', link_id=link.id) }}">
                          <button type="submit" class="btn btn-danger">削除する</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 新しい登録リンク作成モーダル -->
<div class="modal fade" id="newLinkModal" tabindex="-1" aria-labelledby="newLinkModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newLinkModalLabel">新しい登録リンクを作成</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('create_registration_link') }}">
        <div class="modal-body">
          <div class="form-group mb-3">
            <label for="linkName" class="form-label">リンク名</label>
            <input type="text" class="form-control" id="linkName" name="name" required>
            <div class="form-text">例：Instagram用、Twitter用など</div>
          </div>
          <div class="form-group mb-3">
            <label for="folderSelect" class="form-label">フォルダ</label>
            <select class="form-select" id="folderSelect" name="folder_id">
              {% for folder in folders %}
                <option value="{{ folder.id }}" {% if selected_folder_id == folder.id %}selected{% endif %}>{{ folder.name }}</option>
              {% endfor %}
            </select>
          </div>
          <input type="hidden" name="source" value="line">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="submit" class="btn btn-primary">作成</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- フォルダ作成モーダル -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createFolderModalLabel">新しいフォルダを作成</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('create_source_analytics_folder') }}">
        <div class="modal-body">
          <div class="form-group">
            <label for="folderName" class="form-label">フォルダ名</label>
            <input type="text" class="form-control" id="folderName" name="name" required>
            <div class="form-text">例：SNS、広告、イベントなど</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="submit" class="btn btn-primary">作成</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- フォルダ編集モーダル -->
<div class="modal fade" id="editFolderModal" tabindex="-1" aria-labelledby="editFolderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editFolderModalLabel">フォルダ編集</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editFolderForm" method="POST">
        <div class="modal-body">
          <div class="form-group">
            <label for="editFolderName" class="form-label">フォルダ名</label>
            <input type="text" class="form-control" id="editFolderName" name="name" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- フォルダ削除確認モーダル -->
<div class="modal fade" id="deleteFolderModal" tabindex="-1" aria-labelledby="deleteFolderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteFolderModalLabel">フォルダ削除の確認</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>フォルダ「<span id="deleteFolderName"></span>」を削除してもよろしいですか？</p>
        <p class="text-warning">フォルダ内の登録リンクは「未分類」フォルダに移動されます。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <form id="deleteFolderForm" method="POST">
          <button type="submit" class="btn btn-danger">削除する</button>
        </form>
      </div>
    </div>
  </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
    // リンクコピー機能
    document.querySelectorAll('.copy-link').forEach(button => {
        button.addEventListener('click', function() {
            const link = this.dataset.link;
            navigator.clipboard.writeText(link).then(() => {
                alert('リンクをコピーしました');
            });
        });
    });

    // フォルダ編集
    document.querySelectorAll('.edit-folder-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const folderId = this.dataset.folderId;
            const folderName = this.dataset.folderName;
            
            document.getElementById('editFolderName').value = folderName;
            document.getElementById('editFolderForm').action = `/admin/line-source-analytics/folders/edit/${folderId}`;
            
            const modal = new bootstrap.Modal(document.getElementById('editFolderModal'));
            modal.show();
        });
    });

    // フォルダ削除
    document.querySelectorAll('.delete-folder-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const folderId = this.dataset.folderId;
            const folderName = this.dataset.folderName;
            
            document.getElementById('deleteFolderName').textContent = folderName;
            document.getElementById('deleteFolderForm').action = `/admin/line-source-analytics/folders/delete/${folderId}`;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteFolderModal'));
            modal.show();
        });
    });

    // モーダルが閉じられた時の処理
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function() {
            // モーダルのバックドロップを確実に削除
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // bodyのクラスを削除
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        });
    });
});
</script>
{% endblock %} 