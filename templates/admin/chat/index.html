{% extends 'admin/base.html' %}

{% block title %}ãƒãƒ£ãƒƒãƒˆç®¡ç†{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top:0; padding-top:0;">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category if category != 'error' else 'danger' }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="chat-container">
        <!-- å·¦ãƒšã‚¤ãƒ³ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ -->
        <div class="users-pane">
            <div class="search-box">
                <input type="text" id="userSearch" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢...">
            </div>
            <div id="userList" class="user-list">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...
                </div>
            </div>
        </div>
        
        <!-- ä¸­å¤®ãƒšã‚¤ãƒ³ï¼šãƒãƒ£ãƒƒãƒˆå†…å®¹ -->
        <div class="chat-pane">
            <div class="chat-header" id="chatHeader">
                <div class="chat-header-avatar" id="chatHeaderAvatar" style="display: none;">
                    <span class="default-avatar">ğŸ‘¤</span>
                </div>
                <div class="chat-header-name-container">
                    <h5 class="chat-header-name" id="chatHeaderName">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</h5>
                    <span class="chat-header-status" id="chatHeaderStatus" style="display: none;">å¯¾å¿œãƒãƒ¼ã‚¯</span>
                </div>
                <div class="user-status" id="userStatus"></div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <i class="far fa-comments fa-3x mb-3"></i>
                    <p>å·¦å´ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ä¼šè©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
                </div>
            </div>
            
            <div class="message-input">
                <form id="messageForm" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="messageInput" class="form-control" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." required>
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> é€ä¿¡
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- å³ãƒšã‚¤ãƒ³ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒ¡ãƒ¢ -->
        <div class="info-pane">
            <div class="user-info" id="userInfo">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                <div class="empty-state">
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
            </div>
            
            <div class="user-notes" id="userNotes" style="display: none;">
                <div class="note-title">
                    <h5>ãƒ¡ãƒ¢</h5>
                    <button id="editNoteBtn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit"></i> ç·¨é›†
                    </button>
                </div>
                <div id="noteDisplay" class="note-content p-2 bg-white rounded border mb-3" style="min-height: 80px;">
                    <!-- ãƒ¡ãƒ¢å†…å®¹ã¯JavaScriptã§å‹•çš„ã«è¡¨ç¤º -->
                    <div class="empty-state">
                        <p class="small text-muted">ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
            
            <div class="user-tags" id="userTags" style="display: none; padding: 15px; border-top: 1px solid #ddd;">
                <div class="tags-title d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">ã‚¿ã‚°</h5>
                    <button id="editTagsBtn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit"></i> ç·¨é›†
                    </button>
                </div>
                <div id="tagsDisplay" class="mb-3">
                    <!-- ã‚¿ã‚°ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    <div class="empty-state">
                        <p class="small text-muted">ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Socket.IO ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script>
    let selectedUserId = null;
    let users = [];
    let socket = null;
    let pollingInterval = null;
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
        
        // Socket.IOæ¥ç¶š
        connectSocket();
        
        // è‡ªå‹•æ›´æ–°ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹ï¼ˆWebSocketãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        startPolling();
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
        document.getElementById('messageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!selectedUserId) return;
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                sendMessage(selectedUserId, message);
                messageInput.value = '';
            }
        });
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢å‡¦ç†
        document.getElementById('userSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filterUsers(searchTerm);
        });
        
        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã«Socketã¨ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
        
        // æ—¢å­˜ã®DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã«è¿½åŠ ã™ã‚‹å½¢ã§è¨˜è¿°
        const editTagsBtn = document.getElementById('editTagsBtn');
        if (editTagsBtn) {
            editTagsBtn.addEventListener('click', function() {
                if (!selectedUserId) return;
                
                // ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹å‰ã«ã€ç¾åœ¨ã®ã‚¿ã‚°æƒ…å ±ã‚’å–å¾—
                fetch(`/admin/api/user-tags/${selectedUserId}`)
                    .then(response => response.json())
                    .then(data => {
                        showTagEditModal(data.tags || []);
                    })
                    .catch(error => {
                        console.error('Error loading tags for editing:', error);
                        alert('ã‚¿ã‚°æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
            });
        }
    });
    
    // Socket.IOæ¥ç¶š
    function connectSocket() {
        try {
            // ç¾åœ¨ã®æ¥ç¶šã‚’é–‰ã˜ã‚‹
            if (socket) {
                socket.disconnect();
            }
            
            // æ˜ç¤ºçš„ã«ãƒ‘ã‚¹ã¨ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã—ã¦æ¥ç¶š
            socket = io({
                path: '/socket.io',
                transports: ['websocket', 'polling'],
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                timeout: 5000
            });
            
            // æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆ
            socket.on('connect', function() {
                console.log('Socket.IO connected successfully');
                // æ¥ç¶šæˆåŠŸã—ãŸã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                const statusEl = document.getElementById('userStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="badge badge-success">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šä¸­</span>';
                }
            });
            
            // åˆ‡æ–­ã‚¤ãƒ™ãƒ³ãƒˆ
            socket.on('disconnect', function() {
                console.log('Socket.IO disconnected');
                const statusEl = document.getElementById('userStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="badge badge-warning">æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ</span>';
                }
            });
            
            // æ¥ç¶šã‚¨ãƒ©ãƒ¼
            socket.on('connect_error', function(error) {
                console.error('Socket.IO connection error:', error);
                const statusEl = document.getElementById('userStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="badge badge-danger">æ¥ç¶šã‚¨ãƒ©ãƒ¼</span>';
                }
                // ãƒãƒ¼ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç¢ºå®Ÿã«å‹•ä½œã•ã›ã‚‹
                startPolling();
            });
            
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ã
            socket.on('new_message', function(data) {
                console.log('New message received:', data);
                
                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ä¸€è‡´ã™ã‚‹å ´åˆã¯ãƒãƒ£ãƒƒãƒˆã‚’æ›´æ–°
                if (selectedUserId === data.user_id) {
                    loadChatHistory(selectedUserId);
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ï¼ˆæœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹ãŸã‚ï¼‰
                loadUsers();
            });
        } catch (e) {
            console.error('Error initializing Socket.IO:', e);
            // WebSocketæ¥ç¶šã«å¤±æ•—ã—ãŸå ´åˆã€ãƒãƒ¼ãƒªãƒ³ã‚°ã«é ¼ã‚‹
            startPolling();
        }
    }
    
    // ãƒãƒ¼ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹å®šæœŸæ›´æ–°
    function startPolling() {
        // æ—¢å­˜ã®ãƒãƒ¼ãƒªãƒ³ã‚°ãŒã‚ã‚Œã°åœæ­¢
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
        
        // 10ç§’ã”ã¨ã«æ›´æ–°
        pollingInterval = setInterval(function() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            loadUsers();
            
            // é¸æŠä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚Œã°ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚‚æ›´æ–°
            if (selectedUserId) {
                loadChatHistory(selectedUserId);
            }
        }, 10000); // 10ç§’ã”ã¨
        
        console.log('Polling started as WebSocket fallback');
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿
    function loadUsers() {
        fetch('/admin/api/users')
            .then(response => response.json())
            .then(data => {
                users = data.users;
                renderUserList(users);
            })
            .catch(error => {
                console.error('Error loading users:', error);
                document.getElementById('userList').innerHTML = '<div class="empty-state">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderUserList(usersList) {
        const userListElement = document.getElementById('userList');
        userListElement.innerHTML = '';
        
        if (usersList.length === 0) {
            userListElement.innerHTML = '<div class="empty-state">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
            return;
        }
        
        usersList.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'user-list-item';
            userItem.dataset.userId = user.line_user_id;
            
            if (selectedUserId === user.line_user_id) {
                userItem.classList.add('active');
            }
            
            let unreadBadge = '';
            if (user.unread_count > 0) {
                unreadBadge = `<span class="unread-badge float-right">${user.unread_count}</span>`;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºå‡¦ç†
            let userAvatarHtml = '';
            if (user.profile_image_url) {
                userAvatarHtml = `<img src="${user.profile_image_url}" alt="${user.name}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">`;
            } else {
                userAvatarHtml = `<div class="rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; background-color: #cccccc; color: white; font-weight: bold; font-size: 14px;">ğŸ‘¤</div>`;
            }
            
            // å¯¾å¿œãƒãƒ¼ã‚¯ã®è¡¨ç¤ºå‡¦ç†ã‚’è¿½åŠ 
            let statusMarkerHtml = '';
            if (user.status_marker_name && user.status_marker_color) {
                statusMarkerHtml = `<span class="status-marker-inline" style="background-color: ${user.status_marker_color};">${user.status_marker_name}</span>`;
            }
            
            userItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="d-flex align-items-center">
                        ${userAvatarHtml}
                        <div>
                            <strong>${user.name}${statusMarkerHtml}</strong>
                            <div class="small text-muted">${user.last_message || 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</div>
                        </div>
                    </div>
                    ${unreadBadge}
                </div>
            `;
            
            userItem.addEventListener('click', function() {
                selectUser(user.line_user_id);
            });
            
            userListElement.appendChild(userItem);
        });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠ
    function selectUser(userId) {
        if (!userId) return;
        
        selectedUserId = userId;
        
        // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.user-list-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.userId === userId) {
                item.classList.add('active');
            }
        });
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
        loadUserInfo(userId);
        
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
        loadChatHistory(userId);
        
        // ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã‚€
        loadUserNote(userId);
        
        // ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€
        loadUserTags(userId);
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        document.getElementById('messageForm').style.display = 'block';
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿è¾¼ã¿
    function loadUserInfo(userId) {
        fetch(`/admin/api/user/${userId}`)
            .then(response => response.json())
            .then(data => {
                renderUserInfo(data.user);
                updateChatHeader(data.user);
            })
            .catch(error => {
                console.error('Error loading user info:', error);
                document.getElementById('userInfo').innerHTML = '<div class="empty-state">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
    }
    
    // ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›´æ–°
    function updateChatHeader(user) {
        if (!user) return;
        
        const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
        const chatHeaderName = document.getElementById('chatHeaderName');
        const chatHeaderStatus = document.getElementById('chatHeaderStatus');
        
        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
        if (user.profile_image_url) {
            chatHeaderAvatar.innerHTML = `<img src="${user.profile_image_url}" alt="${user.name}">`;
        } else {
            chatHeaderAvatar.innerHTML = '<span class="default-avatar">ğŸ‘¤</span>';
        }
        chatHeaderAvatar.style.display = 'flex';
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¨­å®š
        chatHeaderName.textContent = user.name;
        
        // å¯¾å¿œãƒãƒ¼ã‚¯ã‚’è¨­å®š
        if (user.status_marker_name && user.status_marker_color) {
            chatHeaderStatus.textContent = user.status_marker_name;
            chatHeaderStatus.style.backgroundColor = user.status_marker_color;
            chatHeaderStatus.style.display = 'inline-block';
        } else {
            chatHeaderStatus.style.display = 'none';
        }
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderUserInfo(user) {
        if (!user) return;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚¨ãƒªã‚¢ã‚’æ›´æ–°
        const userInfoElement = document.getElementById('userInfo');
        const profileImg = user.profile_image_url || 'https://via.placeholder.com/100';
        
        // å¯¾å¿œãƒãƒ¼ã‚¯ã®è¡¨ç¤ºHTML
        let statusMarkerHtml = '';
        if (user.status_marker_name && user.status_marker_color) {
            statusMarkerHtml = `
                <div class="status-marker-container">
                    <button class="status-marker-large user-action-button" style="background-color: ${user.status_marker_color}; border: none;" onclick="toggleStatusMarkerDropdown()">
                        ${user.status_marker_name}
                    </button>
                    <div class="status-marker-dropdown" id="statusMarkerDropdown">
                        <!-- å¯¾å¿œãƒãƒ¼ã‚¯ä¸€è¦§ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            `;
        } else {
            statusMarkerHtml = `
                <div class="status-marker-container">
                    <button class="status-marker-large user-action-button" style="background-color: #6c757d; border: none;" onclick="toggleStatusMarkerDropdown()">
                        å¯¾å¿œãƒãƒ¼ã‚¯ãªã—
                    </button>
                    <div class="status-marker-dropdown" id="statusMarkerDropdown">
                        <!-- å¯¾å¿œãƒãƒ¼ã‚¯ä¸€è¦§ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            `;
        }
        
        userInfoElement.innerHTML = `
            <table class="table table-sm">
                <tr>
                    <th scope="row">ç™»éŒ²æ—¥</th>
                    <td>${formatDateTime(user.created_at)}</td>
                </tr>
            </table>
            <div class="mt-3">
                <a id="userDetailLink" href="/admin/user/${user.line_user_id}" class="btn btn-outline-primary user-action-button" target="_blank">
                    <i class="fas fa-user"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°
                </a>
            </div>
            ${statusMarkerHtml}
        `;
        
        // å¯¾å¿œãƒãƒ¼ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        loadStatusMarkerOptions(user.line_user_id);
        
        // ãƒ¡ãƒ¢ã¨ã‚¿ã‚°ã®ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        document.getElementById('userNotes').style.display = 'block';
        document.getElementById('userTags').style.display = 'block';
        
        // ãƒ¡ãƒ¢ç·¨é›†ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        document.getElementById('editNoteBtn').addEventListener('click', function() {
            showNoteEditModal(user.line_user_id);
        });
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿
    function loadChatHistory(userId) {
        fetch(`/admin/api/chat/${userId}`)
            .then(response => response.json())
            .then(data => {
                renderChatHistory(data.messages);
            })
            .catch(error => {
                console.error('Error loading chat history:', error);
                document.getElementById('messagesContainer').innerHTML = '<div class="empty-state">ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderChatHistory(messages) {
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';
        
        if (messages.length === 0) {
            messagesContainer.innerHTML = '<div class="empty-state">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const messagesByDate = {};
        
        messages.forEach(message => {
            const messageDate = new Date(message.sent_at + 'Z'); // JSTã§è‡ªå‹•è¡¨ç¤º
            const formattedDate = messageDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
            
            if (!messagesByDate[formattedDate]) {
                messagesByDate[formattedDate] = [];
            }
            
            messagesByDate[formattedDate].push(message);
        });
        
        // æ—¥ä»˜ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        Object.keys(messagesByDate).sort().forEach(date => {
            // æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã®è¿½åŠ 
            const dateDiv = document.createElement('div');
            dateDiv.className = 'date-separator';
            dateDiv.innerHTML = `<span class="date-text">${date}</span>`;
            messagesContainer.appendChild(dateDiv);
            
            // ãã®æ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            messagesByDate[date].forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.is_from_admin ? 'message-admin' : 'message-user'}`;
                
                // æ™‚é–“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const messageDate = new Date(message.sent_at + 'Z');
                const time = messageDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«ã‚’è¿½åŠ 
                let avatarHtml = '';
                if (!message.is_from_admin) {
                    // LINEã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
                    if (message.profile_image_url) {
                        avatarHtml = `
                            <div class="message-avatar">
                                <img src="${message.profile_image_url}" alt="User Avatar" 
                                     onerror="this.style.display='none'; this.parentNode.innerHTML='<span class=&quot;default-avatar&quot;>U</span>';">
                            </div>
                        `;
                    } else {
                        avatarHtml = `
                            <div class="message-avatar">
                                <span class="default-avatar">U</span>
                            </div>
                        `;
                    }
                }
                
                messageDiv.innerHTML = `
                    ${avatarHtml}
                    <div class="message-content-wrapper">
                        <div class="message-bubble">
                            <div class="message-content">${message.message}</div>
                        </div>
                        <div class="message-info">${time}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
        });
        
        // æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
    function sendMessage(userId, message) {
        fetch('/admin/api/send-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚ŒãŸã‚‰å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
                loadChatHistory(userId);
            } else {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿
    function loadUserNote(userId) {
        fetch(`/admin/api/user-note/${userId}`)
            .then(response => response.json())
            .then(data => {
                // ãƒ¡ãƒ¢ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ›´æ–°
                const noteContent = data.note || '';
                const noteDisplay = document.getElementById('noteDisplay');
                if (noteContent) {
                    noteDisplay.innerHTML = noteContent.replace(/\n/g, '<br>');
                } else {
                    noteDisplay.innerHTML = '<div class="empty-state"><p class="small text-muted">ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading user note:', error);
                document.getElementById('noteDisplay').innerHTML = '<div class="empty-state"><p class="small text-muted">ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
            });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¢ã®ä¿å­˜
    function saveUserNote(userId, note, modalInstance) {
        fetch('/admin/api/save-note', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                note: note
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // ãƒ¡ãƒ¢è¡¨ç¤ºã‚’æ›´æ–°
                loadUserNote(userId);
                
                alert('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } else {
                alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving note:', error);
            alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterUsers(searchTerm) {
        if (!searchTerm) {
            renderUserList(users);
            return;
        }
        
        const filteredUsers = users.filter(user => {
            return user.name.toLowerCase().includes(searchTerm) || 
                  (user.email && user.email.toLowerCase().includes(searchTerm));
        });
        
        renderUserList(filteredUsers);
    }
    
    // å¯¾å¿œãƒãƒ¼ã‚¯é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿
    function loadStatusMarkerOptions(userId) {
        fetch('/admin/api/status-markers')
            .then(response => response.json())
            .then(data => {
                renderStatusMarkerOptions(data.markers || [], userId);
            })
            .catch(error => {
                console.error('Error loading status markers:', error);
            });
    }
    
    // å¯¾å¿œãƒãƒ¼ã‚¯é¸æŠè‚¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderStatusMarkerOptions(markers, userId) {
        const dropdown = document.getElementById('statusMarkerDropdown');
        if (!dropdown) return;
        
        dropdown.innerHTML = '';
        
        // ã€Œå¯¾å¿œãƒãƒ¼ã‚¯ãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const noneOption = document.createElement('div');
        noneOption.className = 'status-marker-option none';
        noneOption.textContent = 'å¯¾å¿œãƒãƒ¼ã‚¯ãªã—';
        noneOption.onclick = () => updateUserStatusMarker(userId, null);
        dropdown.appendChild(noneOption);
        
        // å„å¯¾å¿œãƒãƒ¼ã‚¯
        markers.forEach(marker => {
            const option = document.createElement('div');
            option.className = 'status-marker-option';
            option.style.color = marker.color;
            option.textContent = marker.name;
            option.onclick = () => updateUserStatusMarker(userId, marker.id);
            dropdown.appendChild(option);
        });
    }
    
    // å¯¾å¿œãƒãƒ¼ã‚¯ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
    function toggleStatusMarkerDropdown() {
        const dropdown = document.getElementById('statusMarkerDropdown');
        if (!dropdown) return;
        
        dropdown.classList.toggle('show');
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã®ã¿å¤–å´ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
        if (dropdown.classList.contains('show')) {
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ 
            document.removeEventListener('click', handleOutsideClick);
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);
        }
    }
    
    // å¤–å´ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    function handleOutsideClick(event) {
        const dropdown = document.getElementById('statusMarkerDropdown');
        if (dropdown && !event.target.closest('.status-marker-container')) {
            dropdown.classList.remove('show');
            document.removeEventListener('click', handleOutsideClick);
        }
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¯¾å¿œãƒãƒ¼ã‚¯ã‚’æ›´æ–°
    function updateUserStatusMarker(userId, markerId) {
        fetch('/admin/api/update-user-status-marker', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                marker_id: markerId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
                const dropdown = document.getElementById('statusMarkerDropdown');
                if (dropdown) dropdown.classList.remove('show');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
                loadUserInfo(userId);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
                loadUsers();
            } else {
                alert('å¯¾å¿œãƒãƒ¼ã‚¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error updating status marker:', error);
            alert('å¯¾å¿œãƒãƒ¼ã‚¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚°èª­ã¿è¾¼ã¿
    function loadUserTags(userId) {
        fetch(`/admin/api/user-tags/${userId}`)
            .then(response => response.json())
            .then(data => {
                renderUserTags(data.tags || []);
            })
            .catch(error => {
                console.error('Error loading user tags:', error);
                document.getElementById('tagsDisplay').innerHTML = '<div class="empty-state"><p class="small text-muted">ã‚¿ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
            });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚°ã‚’è¡¨ç¤º
    function renderUserTags(tags) {
        const tagsContainer = document.getElementById('tagsDisplay');
        tagsContainer.innerHTML = '';
        
        if (!tags || tags.length === 0) {
            tagsContainer.innerHTML = '<div class="empty-state"><p class="small text-muted">ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
            return;
        }
        
        // ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã«ã‚¿ã‚°ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const folderGroups = {};
        
        tags.forEach(tag => {
            const folderName = tag.folder_name || 'æœªåˆ†é¡';
            if (!folderGroups[folderName]) {
                folderGroups[folderName] = [];
            }
            folderGroups[folderName].push(tag);
        });
        
        // ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã«ã‚¿ã‚°ã‚’è¡¨ç¤º
        Object.keys(folderGroups).forEach(folderName => {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'tag-folder mb-2';
            
            // ãƒ•ã‚©ãƒ«ãƒ€å
            folderDiv.innerHTML = `<div class="folder-name mb-1"><i class="fas fa-folder text-warning"></i> ${folderName}</div>`;
            
            // ã‚¿ã‚°ãƒªã‚¹ãƒˆ
            const tagsDiv = document.createElement('div');
            tagsDiv.className = 'tag-list ml-3 d-flex flex-wrap';
            
            folderGroups[folderName].forEach(tag => {
                const tagBadge = document.createElement('span');
                tagBadge.className = 'badge bg-info text-white me-2 mb-2';
                tagBadge.textContent = tag.name;
                tagBadge.style.padding = '5px 10px';
                tagsDiv.appendChild(tagBadge);
            });
            
            folderDiv.appendChild(tagsDiv);
            tagsContainer.appendChild(folderDiv);
        });
    }
    
    // ãƒ¡ãƒ¢ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showNoteEditModal(userId) {
        // ã™ã§ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
        const existingModal = document.getElementById('noteEditModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // ç¾åœ¨ã®ãƒ¡ãƒ¢ã‚’å–å¾—
        fetch(`/admin/api/user-note/${userId}`)
            .then(response => response.json())
            .then(data => {
                const currentNote = data.note || '';
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'noteEditModal';
                modal.tabIndex = '-1';
                modal.setAttribute('aria-labelledby', 'noteEditModalLabel');
                modal.setAttribute('aria-hidden', 'true');
                
                let modalHtml = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="noteEditModalLabel">ãƒ¡ãƒ¢ã‚’ç·¨é›†</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <textarea id="noteModalInput" class="form-control" rows="8" placeholder="ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚’å…¥åŠ›...">${currentNote}</textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <button type="button" class="btn btn-primary" id="saveNoteBtn">ä¿å­˜</button>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.innerHTML = modalHtml;
                document.body.appendChild(modal);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
                
                // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                document.getElementById('saveNoteBtn').addEventListener('click', function() {
                    const noteText = document.getElementById('noteModalInput').value.trim();
                    saveUserNote(userId, noteText, modalInstance);
                });
            })
            .catch(error => {
                console.error('Error loading note for editing:', error);
                alert('ãƒ¡ãƒ¢æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    }
    
    // ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showTagEditModal(currentTags) {
        // ã™ã§ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
        const existingModal = document.getElementById('tagEditModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // ã™ã¹ã¦ã®ã‚¿ã‚°ã¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—
        fetch('/admin/api/all-tags')
            .then(response => response.json())
            .then(data => {
                const allTags = data.tags || [];
                
                // ãƒ•ã‚©ãƒ«ãƒ€ã¨ã‚¿ã‚°ã‚’åˆ¥ã€…ã«æ•´ç†
                const folders = allTags.filter(tag => tag.is_folder);
                const tags = allTags.filter(tag => !tag.is_folder);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'tagEditModal';
                modal.tabIndex = '-1';
                modal.setAttribute('aria-labelledby', 'tagEditModalLabel');
                modal.setAttribute('aria-hidden', 'true');
                
                let modalHtml = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="tagEditModalLabel">ã‚¿ã‚°ã‚’ç·¨é›†</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="tag-selection-container">
                `;
                
                // ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã«ã‚¿ã‚°ã‚’è¡¨ç¤º
                folders.forEach(folder => {
                    const folderTags = tags.filter(tag => tag.parent_id === folder.id);
                    
                    modalHtml += `
                        <div class="folder-section mb-3">
                            <h6><i class="fas fa-folder text-warning"></i> ${folder.name}</h6>
                            <div class="tag-options ms-3">
                    `;
                    
                    folderTags.forEach(tag => {
                        const isChecked = currentTags.some(t => t.id === tag.id);
                        modalHtml += `
                            <div class="form-check form-check-inline mb-2">
                                <input class="form-check-input tag-checkbox" type="checkbox" 
                                    id="tag-${tag.id}" value="${tag.id}" ${isChecked ? 'checked' : ''}>
                                <label class="form-check-label" for="tag-${tag.id}">${tag.name}</label>
                            </div>
                        `;
                    });
                    
                    modalHtml += `
                            </div>
                        </div>
                    `;
                });
                
                // æœªåˆ†é¡ã®ã‚¿ã‚°ï¼ˆè¦ªIDãŒãªã„ã‚‚ã®ï¼‰
                const unclassifiedTags = tags.filter(tag => !tag.parent_id);
                if (unclassifiedTags.length > 0) {
                    modalHtml += `
                        <div class="folder-section mb-3">
                            <h6><i class="fas fa-folder text-warning"></i> æœªåˆ†é¡</h6>
                            <div class="tag-options ms-3">
                    `;
                    
                    unclassifiedTags.forEach(tag => {
                        const isChecked = currentTags.some(t => t.id === tag.id);
                        modalHtml += `
                            <div class="form-check form-check-inline mb-2">
                                <input class="form-check-input tag-checkbox" type="checkbox" 
                                    id="tag-${tag.id}" value="${tag.id}" ${isChecked ? 'checked' : ''}>
                                <label class="form-check-label" for="tag-${tag.id}">${tag.name}</label>
                            </div>
                        `;
                    });
                    
                    modalHtml += `
                            </div>
                        </div>
                    `;
                }
                
                modalHtml += `
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <button type="button" class="btn btn-primary" id="saveTagsBtn">ä¿å­˜</button>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.innerHTML = modalHtml;
                document.body.appendChild(modal);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
                
                // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                document.getElementById('saveTagsBtn').addEventListener('click', function() {
                    // é¸æŠã•ã‚ŒãŸã‚¿ã‚°IDã‚’å–å¾—
                    const selectedTagIds = [];
                    document.querySelectorAll('.tag-checkbox:checked').forEach(checkbox => {
                        selectedTagIds.push(parseInt(checkbox.value));
                    });
                    
                    // ã‚¿ã‚°ã‚’ä¿å­˜
                    saveUserTags(selectedUserId, selectedTagIds, modalInstance);
                });
            })
            .catch(error => {
                console.error('Error loading all tags:', error);
                alert('ã‚¿ã‚°æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚°ã‚’ä¿å­˜
    function saveUserTags(userId, tagIds, modalInstance) {
        fetch('/admin/api/save-user-tags', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                tag_ids: tagIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                modalInstance.hide();
                
                // ã‚¿ã‚°è¡¨ç¤ºã‚’æ›´æ–°
                loadUserTags(userId);
                
                alert('ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } else {
                alert('ã‚¿ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving tags:', error);
            alert('ã‚¿ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // formatDateTimeé–¢æ•°ã®å®šç¾©ã‚’è¿½åŠ 
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
</script>
{% endblock %} 