{% extends 'admin/base.html' %}

{% block title %}ãƒãƒ£ãƒƒãƒˆç®¡ç†{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
{% endblock %}

{% block content %}
<div class="chat__page-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="chat__alert chat__alert-{{ category if category != 'error' else 'danger' }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="chat__container">
        <!-- å·¦ãƒšã‚¤ãƒ³ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ -->
        <div class="chat__users-pane">
            <div class="chat__search-box">
                <input type="text" id="userSearch" class="chat__form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢...">
            </div>
            <div id="userList" class="chat__user-list">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                <div class="chat__loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...
                </div>
            </div>
        </div>
        
        <!-- ä¸­å¤®ãƒšã‚¤ãƒ³ï¼šãƒãƒ£ãƒƒãƒˆå†…å®¹ -->
        <div class="chat__chat-pane">
            <div class="chat__chat-header" id="chatHeader">
                <div class="chat__chat-header-avatar" id="chatHeaderAvatar" style="display: none;">
                    <span class="chat__default-avatar">ğŸ‘¤</span>
                </div>
                <div class="chat__chat-header-name-container">
                    <h5 class="chat__chat-header-name" id="chatHeaderName">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</h5>
                    <span class="chat__chat-header-status" id="chatHeaderStatus" style="display: none;">å¯¾å¿œãƒãƒ¼ã‚¯</span>
                </div>
                <div class="chat__user-status" id="userStatus"></div>
            </div>
            
            <div class="chat__messages-container" id="messagesContainer">
                <div class="chat__empty-state">
                    <i class="far fa-comments fa-3x chat__mb-3"></i>
                    <p>å·¦å´ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ä¼šè©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
                </div>
            </div>
            
            <div class="chat__message-input">
                <form id="messageForm" style="display: none;">
                    <div class="chat__input-group">
                        <input type="text" id="messageInput" class="chat__form-control" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." required>
                        <div class="chat__input-group-append">
                            <button type="submit" class="chat__btn chat__btn-primary">
                                <i class="fas fa-paper-plane"></i> é€ä¿¡
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- å³ãƒšã‚¤ãƒ³ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒ¡ãƒ¢ -->
        <div class="chat__info-pane">
            <div class="chat__user-info" id="userInfo">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                <div class="chat__empty-state">
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
            </div>
            
            <div class="chat__user-notes" id="userNotes" style="display: none;">
                <div class="chat__note-title">
                    <h5>ãƒ¡ãƒ¢</h5>
                    <button id="editNoteBtn" class="chat__btn chat__btn-sm chat__btn-outline-primary">
                        <i class="fas fa-edit"></i> ç·¨é›†
                    </button>
                </div>
                <div id="noteDisplay" class="chat__note-content chat__p-2 chat__bg-white chat__rounded chat__border chat__mb-3" style="min-height: 80px;">
                    <!-- ãƒ¡ãƒ¢å†…å®¹ã¯JavaScriptã§å‹•çš„ã«è¡¨ç¤º -->
                    <div class="chat__empty-state">
                        <p class="chat__small chat__text-muted">ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
            
            <div class="chat__user-tags" id="userTags" style="display: none; padding: 15px; border-top: 1px solid #ddd;">
                <div class="chat__tags-title chat__d-flex chat__justify-content-between chat__align-items-center chat__mb-3">
                    <h5 class="chat__mb-0">ã‚¿ã‚°</h5>
                    <button id="editTagsBtn" class="chat__btn chat__btn-sm chat__btn-outline-primary">
                        <i class="fas fa-edit"></i> ç·¨é›†
                    </button>
                </div>
                <div id="tagsDisplay" class="chat__mb-3">
                    <!-- ã‚¿ã‚°ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    <div class="chat__empty-state">
                        <p class="chat__small chat__text-muted">ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Socket.IO ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script>
    let selectedUserId = null;
    let users = [];
    let socket = null;
    let pollingInterval = null;
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    document.addEventListener('DOMContentLoaded', function() {
        // Bootstrap 5ã®å‹•ä½œç¢ºèª
        console.log('Bootstrap version:', typeof bootstrap !== 'undefined' && bootstrap.Modal ? 'Bootstrap 5 loaded' : 'Bootstrap not loaded');
        console.log('jQuery version:', typeof $ !== 'undefined' ? $.fn.jquery : 'jQuery not loaded');
        
        loadUsers();
        
        // Socket.IOæ¥ç¶š
        connectSocket();
        
        // è‡ªå‹•æ›´æ–°ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹ï¼ˆWebSocketãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        startPolling();
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
        document.getElementById('messageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!selectedUserId) return;
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                sendMessage(selectedUserId, message);
                messageInput.value = '';
            }
        });
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢å‡¦ç†
        document.getElementById('userSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filterUsers(searchTerm);
        });
        
        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã«Socketã¨ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    });
    
    // Socket.IOæ¥ç¶š
    function connectSocket() {
        try {
            // ç¾åœ¨ã®æ¥ç¶šã‚’é–‰ã˜ã‚‹
            if (socket) {
                socket.disconnect();
            }
            
            // æ˜ç¤ºçš„ã«ãƒ‘ã‚¹ã¨ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã—ã¦æ¥ç¶š
            socket = io({
                path: '/socket.io',
                transports: ['websocket', 'polling'],
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                timeout: 5000
            });
            
            // æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆ
            socket.on('connect', function() {
                console.log('Socket.IO connected successfully');
                // æ¥ç¶šæˆåŠŸã—ãŸã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                const statusEl = document.getElementById('userStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="chat__badge chat__badge-success">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šä¸­</span>';
                }
            });
            
            // åˆ‡æ–­ã‚¤ãƒ™ãƒ³ãƒˆ
            socket.on('disconnect', function() {
                console.log('Socket.IO disconnected');
                const statusEl = document.getElementById('userStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="chat__badge chat__badge-warning">æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ</span>';
                }
            });
            
            // æ¥ç¶šã‚¨ãƒ©ãƒ¼
            socket.on('connect_error', function(error) {
                console.error('Socket.IO connection error:', error);
                const statusEl = document.getElementById('userStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="chat__badge chat__badge-danger">æ¥ç¶šã‚¨ãƒ©ãƒ¼</span>';
                }
                // ãƒãƒ¼ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç¢ºå®Ÿã«å‹•ä½œã•ã›ã‚‹
                startPolling();
            });
            
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ã
            socket.on('new_message', function(data) {
                console.log('New message received:', data);
                
                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ä¸€è‡´ã™ã‚‹å ´åˆã¯ãƒãƒ£ãƒƒãƒˆã‚’æ›´æ–°
                if (selectedUserId === data.user_id) {
                    loadChatHistory(selectedUserId);
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ï¼ˆæœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹ãŸã‚ï¼‰
                loadUsers();
            });
        } catch (e) {
            console.error('Error initializing Socket.IO:', e);
            // WebSocketæ¥ç¶šã«å¤±æ•—ã—ãŸå ´åˆã€ãƒãƒ¼ãƒªãƒ³ã‚°ã«é ¼ã‚‹
            startPolling();
        }
    }
    
    // ãƒãƒ¼ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹å®šæœŸæ›´æ–°
    function startPolling() {
        // æ—¢å­˜ã®ãƒãƒ¼ãƒªãƒ³ã‚°ãŒã‚ã‚Œã°åœæ­¢
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
        
        // 10ç§’ã”ã¨ã«æ›´æ–°
        pollingInterval = setInterval(function() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            loadUsers();
            
            // é¸æŠä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚Œã°ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚‚æ›´æ–°
            if (selectedUserId) {
                loadChatHistory(selectedUserId);
            }
        }, 10000); // 10ç§’ã”ã¨
        
        console.log('Polling started as WebSocket fallback');
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿
    function loadUsers() {
        fetch('/admin/api/users')
            .then(response => response.json())
            .then(data => {
                users = data.users;
                renderUserList(users);
            })
            .catch(error => {
                console.error('Error loading users:', error);
                document.getElementById('userList').innerHTML = '<div class="chat__empty-state">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function chatRenderUserList(usersList) {
        const userListElement = document.getElementById('userList');
        userListElement.innerHTML = '';
        
        if (usersList.length === 0) {
            userListElement.innerHTML = '<div class="chat__empty-state">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
            return;
        }
        
        usersList.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'chat__user-list-item';
            userItem.dataset.userId = user.line_user_id;
            
            if (selectedUserId === user.line_user_id) {
                userItem.classList.add('chat__active');
            }
            
            let unreadBadge = '';
            if (user.unread_count > 0) {
                unreadBadge = `<span class="chat__unread-badge chat__float-right">${user.unread_count}</span>`;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºå‡¦ç†
            let userAvatarHtml = '';
            if (user.profile_image_url) {
                userAvatarHtml = `<img src="${user.profile_image_url}" alt="${user.name}" class="chat__rounded-circle chat__me-2" style="width: 32px; height: 32px; object-fit: cover;">`;
            } else {
                userAvatarHtml = `<div class="chat__rounded-circle chat__me-2 chat__d-flex chat__align-items-center chat__justify-content-center" style="width: 32px; height: 32px; background-color: #cccccc; color: white; font-weight: bold; font-size: 14px;">ğŸ‘¤</div>`;
            }
            
            // å¯¾å¿œãƒãƒ¼ã‚¯ã®è¡¨ç¤ºå‡¦ç†ã‚’è¿½åŠ 
            let statusMarkerHtml = '';
            if (user.status_marker_name && user.status_marker_color) {
                statusMarkerHtml = `<span class="chat__status-marker-inline" style="background-color: ${user.status_marker_color};">${user.status_marker_name}</span>`;
            }
            
            userItem.innerHTML = `
                <div class="chat__d-flex chat__justify-content-between chat__align-items-center chat__w-100">
                    <div class="chat__d-flex chat__align-items-center">
                        ${userAvatarHtml}
                        <div>
                            <strong>${user.name}${statusMarkerHtml}</strong>
                            <div class="chat__small chat__text-muted">${user.last_message || 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</div>
                        </div>
                    </div>
                    ${unreadBadge}
                </div>
            `;
            
            userItem.addEventListener('click', function() {
                selectUser(user.line_user_id);
            });
            
            userListElement.appendChild(userItem);
        });
    }
    
    // é–¢æ•°åã‚‚çµ±ä¸€
    function renderUserList(usersList) {
        return chatRenderUserList(usersList);
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠ
    function selectUser(userId) {
        if (!userId) return;
        
        selectedUserId = userId;
        
        // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.chat__user-list-item').forEach(item => {
            item.classList.remove('chat__active');
            if (item.dataset.userId === userId) {
                item.classList.add('chat__active');
            }
        });
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
        loadUserInfo(userId);
        
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
        loadChatHistory(userId);
        
        // ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã‚€
        loadUserNote(userId);
        
        // ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€
        loadUserTags(userId);
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        document.getElementById('messageForm').style.display = 'block';
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿è¾¼ã¿
    function loadUserInfo(userId) {
        fetch(`/admin/api/user/${userId}`)
            .then(response => response.json())
            .then(data => {
                renderUserInfo(data.user);
                updateChatHeader(data.user);
            })
            .catch(error => {
                console.error('Error loading user info:', error);
                document.getElementById('userInfo').innerHTML = '<div class="chat__empty-state">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
    }
    
    // ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›´æ–°
    function updateChatHeader(user) {
        if (!user) return;
        
        const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
        const chatHeaderName = document.getElementById('chatHeaderName');
        const chatHeaderStatus = document.getElementById('chatHeaderStatus');
        
        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
        if (user.profile_image_url) {
            chatHeaderAvatar.innerHTML = `<img src="${user.profile_image_url}" alt="${user.name}">`;
        } else {
            chatHeaderAvatar.innerHTML = '<span class="chat__default-avatar">ğŸ‘¤</span>';
        }
        chatHeaderAvatar.style.display = 'flex';
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¨­å®šï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ï¼‰
        chatHeaderName.textContent = user.name;
        chatHeaderName.onclick = function() {
            window.open(`/admin/user/${user.line_user_id}`, '_blank');
        };
        
        // å¯¾å¿œãƒãƒ¼ã‚¯ã‚’è¨­å®š
        if (user.status_marker_name && user.status_marker_color) {
            chatHeaderStatus.textContent = user.status_marker_name;
            chatHeaderStatus.style.backgroundColor = user.status_marker_color;
            chatHeaderStatus.style.display = 'inline-block';
        } else {
            chatHeaderStatus.style.display = 'none';
        }
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderUserInfo(user) {
        if (!user) return;
        
        console.log('renderUserInfo called with user:', user); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚¨ãƒªã‚¢ã‚’æ›´æ–°
        const userInfoElement = document.getElementById('userInfo');
        
        userInfoElement.innerHTML = `
            <table class="chat__table chat__table-sm">
                <tr>
                    <th scope="row">ç™»éŒ²æ—¥</th>
                    <td>${formatDateTime(user.created_at)}</td>
                </tr>
            </table>
        `;
        
        // ãƒ¡ãƒ¢ã¨ã‚¿ã‚°ã®ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        document.getElementById('userNotes').style.display = 'block';
        document.getElementById('userTags').style.display = 'block';
        
        // ãƒ¡ãƒ¢ç·¨é›†ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ï¼‰
        const editNoteBtn = document.getElementById('editNoteBtn');
        console.log('editNoteBtn element:', editNoteBtn); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
        
        if (editNoteBtn) {
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
            editNoteBtn.replaceWith(editNoteBtn.cloneNode(true));
            // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const newEditNoteBtn = document.getElementById('editNoteBtn');
            newEditNoteBtn.addEventListener('click', function() {
                console.log('ãƒ¡ãƒ¢ç·¨é›†ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
                showNoteEditModal(user.line_user_id);
            });
            console.log('ãƒ¡ãƒ¢ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
        } else {
            console.error('editNoteBtnãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¿½åŠ 
        }
        
        // ã‚¿ã‚°ç·¨é›†ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ï¼‰
        const editTagsBtn = document.getElementById('editTagsBtn');
        console.log('editTagsBtn element:', editTagsBtn); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
        
        if (editTagsBtn) {
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
            editTagsBtn.replaceWith(editTagsBtn.cloneNode(true));
            // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const newEditTagsBtn = document.getElementById('editTagsBtn');
            newEditTagsBtn.addEventListener('click', function() {
                console.log('ã‚¿ã‚°ç·¨é›†ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
                // ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹å‰ã«ã€ç¾åœ¨ã®ã‚¿ã‚°æƒ…å ±ã‚’å–å¾—
                fetch(`/admin/api/user-tags/${user.line_user_id}`)
                    .then(response => response.json())
                    .then(data => {
                        showTagEditModal(data.tags || [], user.line_user_id);
                    })
                    .catch(error => {
                        console.error('Error loading tags for editing:', error);
                        alert('ã‚¿ã‚°æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
            });
            console.log('ã‚¿ã‚°ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
        } else {
            console.error('editTagsBtnãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¿½åŠ 
        }
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿
    function loadChatHistory(userId) {
        fetch(`/admin/api/chat/${userId}`)
            .then(response => response.json())
            .then(data => {
                renderChatHistory(data.messages);
            })
            .catch(error => {
                console.error('Error loading chat history:', error);
                document.getElementById('messagesContainer').innerHTML = '<div class="chat__empty-state">ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderChatHistory(messages) {
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';
        
        if (messages.length === 0) {
            messagesContainer.innerHTML = '<div class="chat__empty-state">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const messagesByDate = {};
        
        messages.forEach(message => {
            const messageDate = new Date(message.sent_at + 'Z'); // JSTã§è‡ªå‹•è¡¨ç¤º
            const formattedDate = messageDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
            
            if (!messagesByDate[formattedDate]) {
                messagesByDate[formattedDate] = [];
            }
            
            messagesByDate[formattedDate].push(message);
        });
        
        // æ—¥ä»˜ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        Object.keys(messagesByDate).sort().forEach(date => {
            // æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã®è¿½åŠ 
            const dateSeparator = document.createElement('div');
            dateSeparator.className = 'chat__date-separator';
            dateSeparator.innerHTML = `<span class="chat__date-text">${date}</span>`;
            messagesContainer.appendChild(dateSeparator);
            
            // ãã®æ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            messagesByDate[date].forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = `chat__message ${message.is_from_admin ? 'chat__message-admin' : 'chat__message-user'}`;
                
                let avatarHtml = '';
                if (!message.is_from_admin && message.profile_image_url) {
                    avatarHtml = `<div class="chat__message-avatar"><img src="${message.profile_image_url}" alt="User"></div>`;
                } else if (!message.is_from_admin) {
                    avatarHtml = `<div class="chat__message-avatar"><span class="chat__default-avatar">ğŸ‘¤</span></div>`;
                }
                
                const messageTime = new Date(message.sent_at + 'Z').toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
                
                messageEl.innerHTML = `
                    ${avatarHtml}
                    <div class="chat__message-bubble">
                        <div class="chat__message-content">${escapeHtml(message.message)}</div>
                        <div class="chat__message-info">${messageTime}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageEl);
            });
        });
        
        // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    function sendMessage(userId, message) {
        fetch('/admin/api/send-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // é€ä¿¡æˆåŠŸã—ãŸã‚‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ›´æ–°
                loadChatHistory(userId);
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ï¼ˆæœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
                loadUsers();
            } else {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterUsers(searchTerm) {
        const filteredUsers = users.filter(user => 
            user.name.toLowerCase().includes(searchTerm) ||
            (user.last_message && user.last_message.toLowerCase().includes(searchTerm))
        );
        renderUserList(filteredUsers);
    }
    
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateTime(dateString) {
        if (!dateString) return 'ä¸æ˜';
        const date = new Date(dateString);
        return date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿
    function loadUserNote(userId) {
        fetch(`/admin/api/user-note/${userId}`)
            .then(response => response.json())
            .then(data => {
                const noteDisplay = document.getElementById('noteDisplay');
                if (data.note && data.note.trim()) {
                    noteDisplay.innerHTML = `<div class="chat__note-text">${escapeHtml(data.note)}</div>`;
                } else {
                    noteDisplay.innerHTML = '<div class="chat__empty-state"><p class="chat__small chat__text-muted">ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading user note:', error);
                document.getElementById('noteDisplay').innerHTML = '<div class="chat__empty-state"><p class="chat__small chat__text-danger">ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
            });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚°ã®èª­ã¿è¾¼ã¿
    function loadUserTags(userId) {
        fetch(`/admin/api/user-tags/${userId}`)
            .then(response => response.json())
            .then(data => {
                const tagsDisplay = document.getElementById('tagsDisplay');
                if (data.tags && data.tags.length > 0) {
                    let tagsHtml = '';
                    data.tags.forEach(tag => {
                        const folderName = tag.folder_name ? `${tag.folder_name} > ` : '';
                        tagsHtml += `<span class="chat__badge chat__badge-secondary chat__mr-1 chat__mb-1">${folderName}${tag.name}</span>`;
                    });
                    tagsDisplay.innerHTML = tagsHtml;
                } else {
                    tagsDisplay.innerHTML = '<div class="chat__empty-state"><p class="chat__small chat__text-muted">ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading user tags:', error);
                document.getElementById('tagsDisplay').innerHTML = '<div class="chat__empty-state"><p class="chat__small chat__text-danger">ã‚¿ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
            });
    }
    
    // ãƒ¡ãƒ¢ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆbase.htmlã‹ã‚‰ç¶™æ‰¿ã—ãŸãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰
    function showNoteEditModal(userId) {
        // ç¾åœ¨ã®ãƒ¡ãƒ¢å†…å®¹ã‚’å–å¾—
        fetch(`/admin/api/user-note/${userId}`)
            .then(response => response.json())
            .then(data => {
                const currentNote = data.note || '';
                const noteText = prompt('ãƒ¡ãƒ¢ã‚’ç·¨é›†ã—ã¦ãã ã•ã„:', currentNote);
                
                if (noteText !== null) { // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œãªã‹ã£ãŸå ´åˆ
                    // ãƒ¡ãƒ¢ã‚’ä¿å­˜
                    fetch('/admin/api/save-note', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            note: noteText
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // ãƒ¡ãƒ¢è¡¨ç¤ºã‚’æ›´æ–°
                            loadUserNote(userId);
                        } else {
                            alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving note:', error);
                        alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
            })
            .catch(error => {
                console.error('Error loading current note:', error);
                alert('ç¾åœ¨ã®ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    }
    
    // ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
    function showTagEditModal(currentTags, userId) {
        // å…¨ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
        fetch('/admin/api/all-tags')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('ã‚¿ã‚°ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                const allTags = data.tags;
                const currentTagIds = currentTags.map(tag => tag.id);
                
                // ç°¡æ˜“çš„ãªã‚¿ã‚°é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                let tagOptions = 'ã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ç•ªå·ã‚’å…¥åŠ›ï¼‰:\n\n';
                allTags.forEach((tag, index) => {
                    const isSelected = currentTagIds.includes(tag.id) ? 'âœ“' : 'ã€€';
                    const folderName = tag.parent_id ? '' : 'ğŸ“ ';
                    tagOptions += `${index + 1}: ${isSelected} ${folderName}${tag.name}\n`;
                });
                
                const selectedIndices = prompt(tagOptions + '\nä¾‹: 1,3,5', 
                    currentTags.map(tag => 
                        allTags.findIndex(t => t.id === tag.id) + 1
                    ).join(',')
                );
                
                if (selectedIndices !== null) {
                    const selectedTagIds = [];
                    if (selectedIndices.trim()) {
                        const indices = selectedIndices.split(',').map(s => parseInt(s.trim()) - 1);
                        indices.forEach(index => {
                            if (index >= 0 && index < allTags.length) {
                                selectedTagIds.push(allTags[index].id);
                            }
                        });
                    }
                    
                    // ã‚¿ã‚°ã‚’ä¿å­˜
                    fetch('/admin/api/save-user-tags', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            tag_ids: selectedTagIds
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // ã‚¿ã‚°è¡¨ç¤ºã‚’æ›´æ–°
                            loadUserTags(userId);
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ï¼ˆã‚¿ã‚°æƒ…å ±ãŒå¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
                            loadUsers();
                        } else {
                            alert('ã‚¿ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving tags:', error);
                        alert('ã‚¿ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
            })
            .catch(error => {
                console.error('Error loading all tags:', error);
                alert('ã‚¿ã‚°ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    }
</script>
{% endblock %} 